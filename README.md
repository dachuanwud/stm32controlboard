# STM32 控制板项目 (stm32controlboard)

这是一个基于 STM32F1 系列微控制器的电机控制板项目，主要用于小车/机器人平台控制。该项目支持多种控制接口和电机驱动方式，实现了稳定的移动控制功能。

## 项目概述

该项目设计了一个通用的电机控制系统，可以接收多种信号源的控制命令（遥控器、串口指令等），并通过不同的驱动方式控制电机运动。系统支持多种电机驱动器，包括直接 PWM 控制、RS485 通信控制和 CAN 通信控制等方式。当前默认配置使用 CAN 总线通信驱动双路电机。

## 主要功能

### 多路控制信号接收

* **SBus 遥控器接收**：
  * 通过 UART4 (100000 波特率) 接收 SBus 协议的遥控信号
  * 支持解析 12 个通道的数据
  * 通道映射：前后控制（通道2）、左右控制（通道0）
  * 支持精细控制模式（通道7）和特殊控制模式（通道6）

* **指令控制接收**：
  * 通过 UART5 接收自定义格式的命令
  * 支持直接指定左右电机速度值

* **RS485 通信**：
  * 通过 USART3 实现 RS485 总线通信
  * 主要用于与电机驱动器通信（当使用 RS485 协议驱动时）

* **调试接口**：
  * 通过 USART1 实现调试信息输出（printf 重定向）

### CAN 总线通信与电机驱动

**项目的核心功能之一是通过 CAN 总线驱动电机控制器**：

* **CAN 通信协议实现**：
  * 支持标准 CAN 2.0B 协议，使用扩展帧（29位ID）
  * 使用 8 字节数据帧传输命令和参数
  * 实时反馈通信状态（通过 UART 输出调试信息）

* **支持的电机驱动器**：
  * LKBLS481502 双路电机驱动器（当前默认配置）
  * 单路 CAN 驱动器（通过 `drv_keya.c` 实现）
  * 可灵活切换至其他驱动方式

* **电机控制命令**：
  * 电机使能/失能控制
  * 精确的速度控制（-100~100 映射至 -10000~10000）
  * 独立控制左右电机（A通道和B通道）
  * 自动发送电机保活命令（900ms 间隔）

* **通信地址与ID**：
  * 发送ID（控制板->驱动器）：0x06000000 + 驱动器地址
  * 接收ID（驱动器->控制板）：0x05800000 + 驱动器地址
  * 心跳ID：0x07000000 + 驱动器地址

### 电机运动控制

* **多种驱动方式**：
  * CAN 总线驱动（当前默认）
  * PWM 直接驱动：通过 TIM4 输出 PWM 信号控制电机速度
  * RS485 驱动：通过 RS485 总线控制电机驱动器（`drv_real.c`）
  * 其他驱动支持：玩具级驱动（`drv_toy.c`）、SHB 驱动（`drv_shb.c`）

* **运动控制**：
  * 支持前进/后退控制
  * 支持左右转向控制
  * 支持原地旋转
  * 支持刹车控制（5秒自动释放刹车机制）

### 其他特性

* **运行时刻动态配置**：
  * 通过 `channel_parse.c` 中的宏定义可以选择不同的驱动方式
  * 可以在编译时选择使用哪种电机驱动接口

* **安全保护机制**：
  * 电机控制信号范围限制（-100~100）
  * 自动刹车计时释放机制

## 硬件平台

* **微控制器**：STM32F1 系列（根据代码中使用的时钟配置为 64MHz）
* **通信接口**：
  * CAN：电机控制主接口（速率由 MX_CAN_Init 中配置，当前设置为 500kbps）
  * USART1：调试串口
  * USART3：RS485 通信
  * UART4：SBus 接收（100000 波特率，9 位数据，偶校验，2 停止位）
  * UART5：命令接收
* **控制输出**：
  * TIM4：4 路 PWM 输出（32kHz PWM 频率）
  * GPIO：电机使能和方向控制引脚
    * Left_EN, Left_DIR：左电机使能和方向
    * Right_EN, Right_DIR：右电机使能和方向
    * Left_BK, Right_BK：左右电机刹车控制
  * LED：蓝色状态指示灯

## 代码结构

* **Core/**: 核心应用代码
  * **Inc/**: 头文件
    * `main.h`: 主要的头文件，包含引脚定义和全局函数声明
    * `channel_parse.h`: 通道解析相关函数声明
    * `drv_*.h`: 各个驱动模块的函数声明
  * **Src/**: 源文件
    * `main.c`: 主程序入口，包含初始化和主循环
    * `channel_parse.c`: 遥控器通道和命令解析功能，**包含驱动方式选择**（当前选择 DRV_KEYADOUBLE）
    * `drv_keyadouble.c`: **双路 CAN 总线电机驱动实现**（当前默认驱动方式）
    * `drv_keya.c`: 单路 CAN 总线电机驱动实现
    * `drv_real.c`: RS485 协议电机驱动实现
    * `drv_toy.c`: 玩具级电机驱动实现
    * `drv_shb.c`: SHB 电机驱动实现
    * `stm32f1xx_it.c`: 中断服务程序
    * `stm32f1xx_hal_msp.c`: HAL 底层初始化代码

* **Drivers/**: STM32 HAL 库驱动文件

* **MDK-ARM/**: Keil MDK 工程文件

* **my_car.ioc**: STM32CubeMX 项目配置文件

## 通信协议

### CAN 总线协议（双路驱动）

* **CAN标准**：CAN 2.0B，使用扩展帧（29位ID）
* **通信ID**：
  * 发送ID（TX_ID）：0x06000000 + 驱动器地址
  * 接收ID（RX_ID）：0x05800000 + 驱动器地址
  * 心跳ID：0x07000000 + 驱动器地址
* **通信速率**：500kbps（由 MX_CAN_Init 函数配置）
* **命令格式**：
  * 使能电机: `23 0D 20 01/02 00 00 00 00`（01=通道A，02=通道B）
  * 失能电机: `23 0C 20 01/02 00 00 00 00`
  * 设置速度: `23 00 20 01/02 HH HH LL LL`（HH HH LL LL = 32位速度值）
* **通道定义**：
  * 通道A（MOTOR_CHANNEL_A = 0x01）：左电机
  * 通道B（MOTOR_CHANNEL_B = 0x02）：右电机

### SBus 协议

* 接收参数：100000 波特率，9 位数据，偶校验，2 停止位
* 25 字节数据帧：起始字节 0x0F，结束字节 0x00
* 解析 12 个通道的数据（遥控器的摇杆、开关等输入）
* 通道数据范围映射：282~1722 映射到 1050~1950（约 -100~100）

### 自定义命令协议

* 7 字节数据帧：起始标识 0xFF 0x02，结束标识 0x00
* 包含两个字节的左右电机速度控制值（-100~100）

### RS485 协议

* 使用 Modbus 格式帧，包含 CRC16 校验
* 设备 ID 寻址机制
* 使用功能码 0x06 写单个寄存器控制电机

## 控制逻辑

系统的主要控制逻辑如下：

1. 主循环中每 100ms 检查一次接收缓冲区
2. 当收到完整的 SBus 数据帧或命令帧时，解析数据并控制电机
3. 将遥控器通道值转换为左右电机的速度值：
   * 通道 2（Y 轴）控制前后移动
   * 通道 0（X 轴）控制左右转向
   * 支持差速转向算法
4. 根据配置的电机驱动方式，调用相应的接口函数控制电机
   * 当前默认使用 CAN 总线方式（`drv_keyadouble.c` 中实现）
5. 刹车控制：当电机速度为 0 时自动释放刹车，5 秒后自动刹车

## 如何编译与烧录

1. **开发环境**：
   * Keil MDK-ARM (推荐 MDK5)
   * 或其他支持 ARM 开发的 IDE（如 STM32CubeIDE）

2. **通过 Keil MDK-ARM 编译**：
   * 打开 MDK-ARM 目录下的工程文件
   * 选择正确的目标配置
   * 编译项目

3. **烧录程序**：
   * 使用 ST-Link 或 J-Link 等调试器
   * 通过 SWD 接口连接到板子
   * 使用开发环境的下载功能烧录固件

4. **改变驱动类型**：
   * 修改 `channel_parse.c` 文件中的驱动选择宏定义（默认为 `DRV_KEYADOUBLE`）
   * 重新编译项目

## 使用说明

1. **遥控器控制**：
   * 通道 2（右摇杆上下）：控制前进/后退
   * 通道 0（左摇杆左右）：控制左右转向
   * 通道 6 设为高电平：启用特殊控制模式（使用通道 3 替代通道 0）
   * 通道 7 设为高电平：启用低速模式（速度减半）

2. **串口命令控制**：
   * 发送自定义帧格式的命令到 UART5
   * 直接指定左右电机的速度值（-100~100）

3. **CAN总线配置**：
   * 默认使用双路CAN驱动（LKBLS481502驱动器）
   * 通过修改 `channel_parse.c` 中的宏定义可切换驱动方式
   * CAN总线调试信息会通过UART5输出

4. **状态指示**：
   * 蓝色 LED：接收到命令时闪烁指示

## 未来改进方向

* 增加更多类型的电机驱动支持
* 添加编码器反馈和 PID 控制功能
* 实现更复杂的运动控制算法
* 添加无线通信模块支持
* 集成更多传感器接口
* CAN总线接收功能增强（接收驱动器反馈数据）

---

*本文档基于对代码的分析生成，实际使用时可能需要根据硬件平台进行调整。*