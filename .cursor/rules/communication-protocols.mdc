---
description:
globs:
alwaysApply: false
---
# STM32控制板通信协议

## CAN总线协议

项目默认使用CAN总线与LKBLS481502双路电机驱动器通信：

- **CAN标准**：CAN 2.0B，使用扩展帧（29位ID）
- **通信速率**：500kbps
- **通信ID**：
  - 发送ID：0x06000000 + 驱动器地址
  - 接收ID：0x05800000 + 驱动器地址
  - 心跳ID：0x07000000 + 驱动器地址
- **命令格式**：
  - 使能电机: `23 0D 20 01/02 00 00 00 00`（01=通道A，02=通道B）
  - 失能电机: `23 0C 20 01/02 00 00 00 00`
  - 设置速度: `23 00 20 01/02 HH HH LL LL`（HH HH LL LL = 32位速度值）
  
实现文件：[drv_keyadouble.c](mdc:Core/Src/drv_keyadouble.c)

## SBus协议

通过UART4接收SBus遥控器信号：

- **通信参数**：100000波特率，9位数据，偶校验，2停止位
- **数据格式**：25字节数据帧（起始字节0x0F，结束字节0x00）
- **通道映射**：
  - 通道2（Y轴）：控制前后移动
  - 通道0（X轴）：控制左右转向
  - 通道6：特殊控制模式
  - 通道7：低速模式

解析函数在[main.c](mdc:Core/Src/main.c)的`parse_sbus_msg`函数中。

## 命令控制协议

通过UART5接收自定义格式的命令：

- **数据格式**：7字节数据帧
  - 起始标识：0xFF 0x02
  - 数据：左右电机速度控制值（-100~100）
  - 结束标识：0x00

## RS485协议

当使用RS485驱动方式时，通过USART3与电机驱动器通信：

- **协议格式**：Modbus格式帧，包含CRC16校验
- **设备寻址**：通过设备ID
- **功能码**：使用0x06写单个寄存器控制电机

实现文件：[drv_real.c](mdc:Core/Src/drv_real.c)
